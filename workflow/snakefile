SAMPLES = [
    "SRR2584863",
    "SRR2584866",
    "SRR2589044",]

REPLICATE = [1, 2]

fastq_map = {
    "SRR2589044_1" : "004",
    "SRR2589044_2" : "004",
    "SRR2584863_1" : "003",
    "SRR2584863_2" : "003",
    "SRR2584866_1" : "006",
    "SRR2584866_2" : "006",
}

rule fetch_fastq:
    params:
        region=lambda wc: fastq_map[f"{wc.sample}_{wc.replicate}"],
        url=lambda wc: f"ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR258/{fastq_map[f'{wc.sample}_{wc.replicate}']}/{wc.sample}/{wc.sample}_{wc.replicate}.fastq.gz"
    output:
        "data/untrimmed_fastq/{sample}_{replicate}.fastq.gz"
    shell:
        "curl -L -o {output} {params.url}"

rule unzip_fastq:
    input:
        "data/untrimmed_fastq/{sample}_{replicate}.fastq.gz"
    output:
        "data/untrimmed_fastq/{sample}_{replicate}.fastq"
    shell:
        "gunzip -c {input} > {output}"
        
rule fastqc:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "data/untrimmed_fastq/{sample}_{replicate}.fastq"
    output:
        "data/untrimmed_fastq/{sample}_{replicate}_fastqc.html",
        "data/untrimmed_fastq/{sample}_{replicate}_fastqc.zip"
    shell:
        "fastqc {input}" 

rule move_fastq_to_results:
    input:
        "data/untrimmed_fastq/{filename}"
    output:
        "results/untrimmed_fastqc/{filename}"
    shell:
        "mv {input} {output}"

rule unzip_fastqc:
    input:
        "results/untrimmed_fastqc/{sample}_fastqc.zip"
    output:
        "results/untrimmed_fastqc/{sample}_fastqc/Icons/fastqc_icon.png"
        "results/untrimmed_fastqc/{sample}_fastqc/Icons/warning.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Icons/error.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Icons/tick.png",
        "results/untrimmed_fastqc/{sample}_fastqc/summary.txt",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_base_quality.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_base_quality.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_tile_quality.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_tile_quality.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_sequence_quality.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_sequence_quality.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_base_sequence_content.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_base_sequence_content.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_sequence_gc_content.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_sequence_gc_content.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_base_n_content.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/per_base_n_content.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/sequence_length_distribution.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/sequence_length_distribution.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/duplication_levels.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/duplication_levels.png",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/adapter_content.svg",
        "results/untrimmed_fastqc/{sample}_fastqc/Images/adapter_content.png",
        "results/untrimmed_fastqc/{sample}_fastqc/fastqc_report.html",
        "results/untrimmed_fastqc/{sample}_fastqc/fastqc_data.txt",
        "results/untrimmed_fastqc/{sample}_fastqc/fastqc.fo"

rule concatenate_results_summary:
    input:
        "results/untrimmed_fastqc/{sample}_fastqc/summary.txt",
    output:
        "results/untrimmed_fastqc/fastqc_summaries.txt"
    shell:
        "cat {wildcards.sample}_fastqc/summary.txt > {output}"

rule trim_fastq:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "data/untrimmed_fastq/{sample}_1.fastq",
        "data/untrimmed_fastq/{sample}_2.fastq",
        "data/adapters/NexteraPE-PE.fa"
    output:
        "data/untrimmed_fastq/{sample}_1.trim.fastq",
        "data/untrimmed_fastq/{sample}_1un.trim.fastq",
        "data/untrimmed_fastq/{sample}_2.trim.fastq",
        "data/untrimmed_fastq/{sample}_2u.trim.fastq"
    shell:
        "trimmomatic PE {input[0]} {input[1]} {output[0]} {output[1]} {output[2]} {output[3]} " 
        "SLIDINGWINDOW:4:20 MINLEN:25 ILLUMINACLIP:{input[2]}:2:40:15"

rule move_trimmed_fastq_to_trimmed_dir:
    input:
        "data/untrimmed_fastq/{sample}_{replicate}{un}.trim.fastq"
    output:
        "data/trimmed_fastq/{sample}_{replicate}{un}.trim.fastq"
    wildcard_constraints:
        replicate="[1-2]",
        un="[^/]*"
    shell:
        "mv {input} {output}"

rule fetch_ecoli_reference_genome:
    output:
       "data/ref_genome/ecoli_rel606.fasta.gz" 
    shell:
        "curl -L -o {output} "
        "ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/000/017/985/GCA_000017985.1_ASM1798v1/GCA_000017985.1_ASM1798v1_genomic.fna.gz"

rule unzip_ref_genome:
    input:
       "data/ref_genome/ecoli_rel606.fasta.gz" 
    output:
       "data/ref_genome/ecoli_rel606.fasta" 
    shell:
        "gunzip {input}"

rule fastqc_test_1:
    container:
        "containers/ecoli-bioinformatics.sif"
    output:
        "tests/fastqc_test_1"
    shell:
        "which fastqc > {output}"

rule bwa_test_1:
    container:
        "containers/ecoli-bioinformatics.sif"
    output:
        "tests/bwa_test_1"
    shell:
        "bwa > tests/bwa_test_1 2>&1"

rule bwa_test_2:
    container:
        "containers/ecoli-bioinformatics.sif"
    output:
        "tests/bwa_test_2"
    shell:
        "which bwa > {output}"

rule test_container:
    container:
        "containers/ecoli-bioinformatics.sif"
    output:
        "tests/container_test"
    shell:
        "uname -a > tests/container_test"

rule index_ref_genome:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "data/ref_genome/ecoli_rel606.fasta"
    output:
        "data/ref_genome/ecoli_rel606.fasta.amb",
        "data/ref_genome/ecoli_rel606.fasta.ann",
        "data/ref_genome/ecoli_rel606.fasta.bwt",
        "data/ref_genome/ecoli_rel606.fasta.pac",
        "data/ref_genome/ecoli_rel606.fasta.sa"
    shell:
        "bwa index {input}"

rule fetch_trimmed_fastq:
    output:
        directory("data/trimmed_fastq_small/sub")
    shell:"""
        curl -L -o sub.tar.gz https://ndownloader.figshare.com/files/14418248
        tar xvf sub.tar.gz
        mv sub/ data/trimmed_fastq_small
    """

rule run_bwa_mem:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "data/ref_genome/ecoli_rel606.fasta",
        "data/trimmed_fastq_small/sub/{sample}_1.trim.sub.fastq",
        "data/trimmed_fastq_small/sub/{sample}_2.trim.sub.fastq"
    output:
        "results/sam/{sample}.aligned.sam"
    shell:
        "bwa mem {input[0]} {input[1]} {input[2]} > {output}"

rule sam_to_bam:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "results/sam/{sample}.aligned.sam"
    output:
        "results/bam/{sample}.aligned.bam"
    shell:
        "samtools view -S -b {input} > {output}"

rule sort_bam:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "results/bam/{sample}.aligned.bam"
    output:
        "results/bam/{sample}.aligned.sorted.bam"
    shell:
        "samtools sort -o {output} {input}"

rule calculate_read_coverage:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "data/ref_genome/ecoli_rel606.fasta",
        "results/bam/{sample}.aligned.sorted.bam"
    output:
        "results/bcf/{sample}_raw.bcf"
    shell:
        "bcftools mpileup -O b -o {output} "
        "-f {input[0]} {input[1]}"

rule detect_snv:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "results/bcf/{sample}_raw.bcf"
    output:
        "results/vcf/{sample}_variants.vcf"
    shell:
        "bcftools call --ploidy 1 -m -v -o {output} {input}"

rule filter_and_report:
    container:
        "containers/ecoli-bioinformatics.sif"
    input:
        "results/vcf/{sample}_variants.vcf"
    output:
        "results/vcf/{sample}_final_variants.vcf"
    shell:
        "vcfutils.pl varFilter {input} > {output}"