name: Build and Convert Container

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'workflow/Dockerfile'
      - '.github/workflows/build-container.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-convert:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build or Pull Docker image
      working-directory: ./workflow
      run: |
        # Try to pull from registry first (if it exists), otherwise build
        if docker pull ecoli-bioinformatics:latest 2>/dev/null; then
          echo "Successfully pulled image from registry"
        else
          echo "Image not found in registry, building from Dockerfile..."
          docker build -t ecoli-bioinformatics:latest .
        fi
        docker save ecoli-bioinformatics:latest -o ../containers/ecoli-bioinformatics.tar
      
    - name: Install Apptainer
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        export VERSION=1.3.4
        # Detect architecture dynamically
        ARCH=$(uname -m)
        if [ "$ARCH" = "x86_64" ]; then
          DEB_ARCH="amd64"
        elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
          DEB_ARCH="arm64"
        else
          echo "Unsupported architecture: $ARCH"
          exit 1
        fi
        echo "Detected architecture: $ARCH, using $DEB_ARCH package"
        wget https://github.com/apptainer/apptainer/releases/download/v${VERSION}/apptainer_${VERSION}_${DEB_ARCH}.deb
        sudo apt-get install -y ./apptainer_${VERSION}_${DEB_ARCH}.deb
        apptainer --version
        # Clean up downloaded package
        rm -f apptainer_${VERSION}_${DEB_ARCH}.deb
      
    - name: Convert Docker image to Apptainer .sif
      run: |
        mkdir -p containers
        apptainer build containers/ecoli-bioinformatics.sif docker-archive://containers/ecoli-bioinformatics.tar
        ls -lh containers/ecoli-bioinformatics.sif
      
    - name: Test container
      run: |
        apptainer exec containers/ecoli-bioinformatics.sif fastqc --version
        apptainer exec containers/ecoli-bioinformatics.sif trimmomatic -version
        apptainer exec containers/ecoli-bioinformatics.sif bwa 2>&1 | head -5
      
    - name: Upload .sif file as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ecoli-bioinformatics-sif
        path: containers/ecoli-bioinformatics.sif
        retention-days: 30

